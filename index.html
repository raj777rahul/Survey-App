<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Survey App</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h2>Survey App</h2>

  <label for="owner">Shop Owner:</label>
  <select id="owner">
    <option value="Amit">Amit</option>
    <option value="Sumit">Sumit</option>
    <option value="Ajit">Ajit</option>
    <option value="Sujit">Sujit</option>
  </select>

  <br><br>

  <label for="cameraSelect">Select Camera:</label>
  <select id="cameraSelect"></select>
  <button id="startCamera">Start Camera</button>
  <br><br>

  <video id="video" width="320" height="240" autoplay></video>
  <br><br>
  <button id="capture">Capture Photo</button>
  <br><br>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <br><br>
  <button id="getLocation">Get Location</button>
  <p id="location"></p>

  <br><br>
  <button id="exportExcel">Export to Excel</button>

  <script>
    let stream;
    let capturedImageURL = '';
    let surveyData = [];

    // Camera list
    navigator.mediaDevices.enumerateDevices().then(devices => {
      const select = document.getElementById('cameraSelect');
      devices.forEach(device => {
        if (device.kind === 'videoinput') {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `Camera ${select.length + 1}`;
          select.appendChild(option);
        }
      });
    });

    // Start camera
    document.getElementById('startCamera').addEventListener('click', () => {
      const deviceId = document.getElementById('cameraSelect').value;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } }).then(s => {
        stream = s;
        document.getElementById('video').srcObject = stream;
      });
    });

    // Capture photo
    document.getElementById('capture').addEventListener('click', () => {
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        capturedImageURL = URL.createObjectURL(blob);
        alert('Photo captured!');
      }, 'image/jpeg');
    });

    // Get location
    document.getElementById('getLocation').addEventListener('click', () => {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        document.getElementById('location').innerText = `Lat: ${lat}, Lon: ${lon}`;
      });
    });

    // Export to Excel
    document.getElementById('exportExcel').addEventListener('click', () => {
      const owner = document.getElementById('owner').value;
      const locationText = document.getElementById('location').innerText;
      const photoLink = capturedImageURL ? `=HYPERLINK("${capturedImageURL}", "Download Photo")` : '';

      surveyData.push({
        Owner: owner,
        Location: locationText,
        Photo: photoLink
      });

      const worksheet = XLSX.utils.json_to_sheet(surveyData, { origin: 'A1' });
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'SurveyData');

      const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      saveAs(new Blob([wbout], { type: 'application/octet-stream' }), 'SurveyReport.xlsx');
    });
  </script>
</body>
</html>
